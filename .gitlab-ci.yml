stages:
  - module-pipeline
  - consume-dotenv
  - deploy

frontend:
  stage: module-pipeline
  trigger:
    include: /frontend/.gitlab-ci.yml
    strategy: depend
  only:
    changes:
      - frontend/**/*

backend:
  stage: module-pipeline
  trigger:
    include: /backend/.gitlab-ci.yml
    strategy: depend
  only:
    changes:
      - backend/**/*

consume-dotenv-from-module-pipeline:
  stage: consume-dotenv
  script:
    - >
      echo -e "BACKEND_VERSION=$BACKEND_VERSION\n
      FRONTEND_VERSION=$FRONTEND_VERSION" >> .env
  needs:
    - job: get-backend-version
      artifacts: true
      optional: true
    - job: get-frontend-version
      artifacts: true
      optional: true
  artifacts:
    reports:
      dotenv: .env

deploy-app:
  stage: deploy
  trigger:
    include: /infrastructure/kubernetes/.gitlab-ci.yml
    strategy: depend
  needs:
    - job: consume-dotenv-from-module-pipeline
      artifacts: true
  only:
    changes:
      - backend/**/*
      - frontend/**/*
      - infrastructure/kubernetes/**/*